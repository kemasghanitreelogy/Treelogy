{% comment %}
  -----------------------------------------------------------------------------
  SNIPPET: Product Reels Gallery (Variant Selector Version)
  -----------------------------------------------------------------------------
{% endcomment %}

{%- assign story_metaobjects = product.metafields.custom.content_reels.value -%}

{% if story_metaobjects != blank %}
  
  {{ 'product-stories.css' | asset_url | stylesheet_tag }}
  <script src="{{ 'product-stories.js' | asset_url }}" defer="defer"></script>

  <div class="story-section-wrapper" style="margin-top: 30px;">
    
    {% if section.settings.story_title != blank %}
      <div class="reels-title" style="padding: 0 5px; margin-bottom: 10px; font-weight: bold; color: {{ section.settings.story_text_color }};">
        {{ section.settings.story_title }}
      </div>
    {% endif %}

    <div class="reels-grid">
      {% for metaobject in story_metaobjects %}
        {% assign file = metaobject.content.value %}
        {% assign title = metaobject.title.value %}

        <div class="reel-card" onclick="openStoryPlayer({{ forloop.index0 }})">
          {% if file.media_type == 'video' %}
            <img src="{{ file.preview_image | image_url: width: 300, height: 533, crop: 'center' }}" loading="lazy" width="150" height="266" alt="{{ title }}">
            <div class="reel-icon-video"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></div>
          {% else %}
            <img src="{{ file | image_url: width: 300, height: 533, crop: 'center' }}" loading="lazy" width="150" height="266" alt="{{ title }}">
            <div class="reel-icon-video">
               <?xml version="1.0" encoding="UTF-8"?>
              <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="24" height="24">
              <path d="M0 0 C0.66 0 1.32 0 2 0 C2 2.31 2 4.62 2 7 C-0.31 7 -2.62 7 -5 7 C-5 6.34 -5 5.68 -5 5 C-3.35 5 -1.7 5 0 5 C0 3.35 0 1.7 0 0 Z " fill="#000000" transform="translate(19,14)"/>
              <path d="M0 0 C0.66 0 1.32 0 2 0 C2 1.65 2 3.3 2 5 C3.65 5 5.3 5 7 5 C7 5.66 7 6.32 7 7 C4.69 7 2.38 7 0 7 C0 4.69 0 2.38 0 0 Z " fill="#000000" transform="translate(3,14)"/>
              <path d="M0 0 C2.31 0 4.62 0 7 0 C7 2.31 7 4.62 7 7 C6.34 7 5.68 7 5 7 C5 5.35 5 3.7 5 2 C3.35 2 1.7 2 0 2 C0 1.34 0 0.68 0 0 Z " fill="#000000" transform="translate(14,3)"/>
              <path d="M0 0 C2.31 0 4.62 0 7 0 C7 0.66 7 1.32 7 2 C5.35 2 3.7 2 2 2 C2 3.65 2 5.3 2 7 C1.34 7 0.68 7 0 7 C0 4.69 0 2.38 0 0 Z " fill="#000000" transform="translate(3,3)"/>
              </svg>

              </svg>
            </div>
          {% endif %}
          <div class="reel-gradient"></div>
          {% if title != blank %}<div class="reel-title">{{ title }}</div>{% endif %}
        </div>
      {% endfor %}
    </div>

    <div id="story-overlay">
      <div class="story-player-container">
        
        <div class="story-progress-bars" id="story-bars-container"></div>
        <button class="story-close" id="story-close-btn">âœ•</button>
        <button class="story-volume-btn" id="story-volume-btn">
          <span>Tap to unmute</span>
          <div class="icon-muted">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 5L6 9H2V15H6L11 19V5Z"></path><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
          </div>
          <div class="icon-unmuted">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
          </div>
        </button>

        <div class="story-media-wrapper" id="story-media-display"></div>
        <div class="tap-prev" id="story-tap-prev"></div>
        <div class="tap-next" id="story-tap-next"></div>

        <div class="story-cta-container">
          
          <div id="story-variant-list" class="story-variant-list"></div>

          <div id="story-variant-trigger" class="story-variant-trigger">
            <span id="story-variant-label">Select Variant</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#515e56" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="18 15 12 9 6 15"></polyline>
            </svg>
          </div>

          <button id="story-atc-btn" class="story-atc-btn" style="background: {{ section.settings.story_btn_bg }}; color: {{ section.settings.story_btn_text }};">
            {{ section.settings.story_cta_text | default: 'Add to Cart' }}
          </button>
        </div>

      </div>
    </div>
  </div>

  <script type="application/json" id="product-story-data">
    [
      {% for metaobject in story_metaobjects %}
        {% assign file = metaobject.content.value %}
        {
          "type": "{{ file.media_type }}",
          "url": "{% if file.media_type == 'video' %}{% for source in file.sources %}{% if source.format == 'mp4' %}{{ source.url }}{% break %}{% endif %}{% endfor %}{% else %}{{ file | image_url: width: 1080 }}{% endif %}",
          "duration": {% if file.media_type == 'video' %} 0 {% else %} 5000 {% endif %},
          "variant_id": {{ product.selected_or_first_available_variant.id }},
          "cta_text": "{{ section.settings.story_cta_text | default: 'Add to Cart' | escape }}"
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  </script>

  <script type="application/json" id="product-variants-data">
    [
      {% for variant in product.variants %}
        {
          "id": {{ variant.id }},
          "title": "{{ variant.title | escape }}",
          "price": "{{ variant.price | money_without_trailing_zeros }}",
          "available": {{ variant.available }}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    ]
  </script>

{% endif %}