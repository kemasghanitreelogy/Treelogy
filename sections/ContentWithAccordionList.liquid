{% assign should_be_showed = false %}
{% for block in section.blocks %}
  {% if block.settings.title != blank %}
    {% assign should_be_showed = true %}
    {% break %}
  {% endif %}
{% endfor %}

{%- assign mt = section.settings.margin_top_mobile -%}
{%- assign mb = section.settings.margin_bottom_mobile -%}

<style>
  /* Mobile (Base) */
  #shopify-section-{{ section.id }} {
    margin-top: {{ mt }}px;
    margin-bottom: {{ mb }}px;
  }

  /* Tablet */
  @media only screen and (min-width: 768px) {
    #shopify-section-{{ section.id }} {
      margin-top: {{ mt | times: 1.5 | round }}px;
      margin-bottom: {{ mb | times: 1.5 | round }}px;
    }
  }

  /* Desktop */
  @media only screen and (min-width: 1024px) {
    #shopify-section-{{ section.id }} {
      margin-top: {{ mt | times: 2 | round }}px;
      margin-bottom: {{ mb | times: 2 | round }}px;
    }
  }
</style>

{% unless should_be_showed %}
  <style>
    #shopify-section-{{ section.id }} {
      display: none;
    }
  </style>
{% endunless %}

<style>
  /* --- ACCORDION CORE STYLES --- */
  .accordion-description.rte {
    line-height: 1.6;
    word-break: break-word;
    /* Hidden State */
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    /* Default Transition: Standard Slide (Bottom to Top) */
    transition: max-height 0.4s ease-out
    , opacity 0.4s ease-out;
    padding-bottom: 0;
    will-change: max-height
    , opacity;
  }

  /* Open State */
  .accordion.active .accordion-description.rte {
    opacity: 1;
    /* max-height is set by JS */
  }

  /* --- SPECIAL ANIMATION: Sibling Triggered (Top to Down) --- */
  .accordion-description.collapse-top-down {
    /* Wipes content from Top to Bottom */
    animation: clipTopDown 0.4s ease-out forwards;
  }

  @keyframes clipTopDown {
    0% {
      clip-path: inset(0 0 0 0);
      opacity: 1;
    }
    100% {
      clip-path: inset(100% 0 0 0);
      opacity: 0;
    }
  }

  /* Standard RTE Styling */
  .accordion-description.rte p {
    margin-bottom: 0;
  }
  .accordion-description.rte > :last-child {
    margin-bottom: 0;
  }
  .accordion-description.rte ul,
  .accordion-description.rte ol {
    margin-left: 20px;
    margin-bottom: 15px;
    list-style-position: outside;
  }
  .accordion-description.rte ul {
    list-style: disc;
    display: flex;
    flex-direction: column;
    row-gap: 15px;
  }

  /* Header Styling */
  .title-section-accordion {
    font-size: 24px !important;
    font-weight: 600 !important;
  }

  .accordion-list-item.extended-item {
    display: none;
  }
  .accordion-list.accordion-list-section {
    padding: 0 !important;
  }

  @media only screen and (max-width: 900px) {
    .sub-content-header {
      margin-bottom: 25px;
    }
    .sub-content-header p {
      font-weight: 300;
    }
  }

  #Accordion-{{ section.id }}
  .scroll-container .accordion-header {
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  #Accordion-{{ section.id }}
  .scroll-container .accordion-header h2 {
    font-size: 16px;
    font-weight: {{ section.settings.accordion_header_weight }};
    color: #567350;
    line-height: 25px;
    margin-bottom: 0;
    margin-right: 30px;
  }

  /* "See More" Toggle Logic */
  .accordion-toggle-checkbox {
    display: none;
  }
  .accordion-toggle-checkbox:checked ~ .scroll-container .accordion-list-item.extended-item {
    display: block;
    animation: fadeIn 0.5s ease;
  }

  .text-less {
    display: none;
  }
  .text-more {
    display: inline;
  }
  .accordion-toggle-checkbox:checked ~ .see-more-label .text-more {
    display: none;
  }
  .accordion-toggle-checkbox:checked ~ .see-more-label .text-less {
    display: inline;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .see-more-label {
    margin-top: 20px;
    text-align: left;
    text-decoration: underline;
    cursor: pointer;
    display: inline-block;
    user-select: none;
    color: #567350;
    font-size: 16px;
  }

  .accordion-header svg {
    width: 12px;
    height: 12px;
    flex-shrink: 0;
    transition: transform 0.3s ease;
  }

  /* Optional: Rotate icon when active */
  .accordion.active .accordion-header svg {
    transform: rotate(45deg);
  }
</style>

<div class="main-grid" id="Accordion-{{ section.id }}">
  <div class="left-content">
    <h2 class="title-section-accordion" style="color: {{ section.settings.heading_color }};">
      {{ section.settings.title }}
    </h2>
    {% if section.settings.description != blank %}
      <div class="sub-content-header">
        <p>{{ section.settings.description }}</p>
        {% render 'PrimaryButton'
          , url: section.settings.button_url
          , title: section.settings.button_label
          , type: 'transparent'
        %}
      </div>
    {% endif %}
  </div>

  <div class="right-list">

    {% assign limit = section.settings.limit_count | default: 5 %}

    <input
      type="checkbox"
      id="ShowMore-{{ section.id }}"
      class="accordion-toggle-checkbox">

    <div class="scroll-container __accordion">
      {% for block in section.blocks %}

        {% assign is_extended = false %}
        {% if forloop.index > limit %}
          {% assign is_extended = true %}
        {% endif %}

        <div class="accordion __accordion-wrapper accordion-list-item {% if is_extended %}extended-item{% endif %}" {{ block.shopify_attributes }}>
          <div class="accordion-header __accordion-button">
            <h2 class="text-start py-2 text-2xl md:text-4xl">
              {{ block.settings.title }}
            </h2>

            {% if section.settings.custom_icon != blank %}
              {{ section.settings.custom_icon }}
            {% else %}
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 12 12">
                <path fill="#2B3C35" d="M7 5V0H5v5H0v2h5v5h2V7h5V5H7Z" />
              </svg>
            {% endif %}

          </div>
          <div class="accordion-description __accordion-content rte" style="color: {{ section.settings.accordion_text_color }};">
            {{ block.settings.description }}
          </div>
        </div>
      {% endfor %}
    </div>

    {% if section.blocks.size > limit %}
      <label for="ShowMore-{{ section.id }}" class="see-more-label">
        <span class="text-more">{{ section.settings.see_more_label | default: 'See More' }}</span>
        <span class="text-less">{{ section.settings.see_less_label | default: 'See Less' }}</span>
      </label>
    {% endif %}

  </div>
</div>

<script>
  (function() {
    function initAccordion(container) {
      if (!container) return;
      const items = container.querySelectorAll(".accordion");

      items.forEach(item => {
        // Clone header to remove old listeners (Clean for Theme Editor)
        const header = item.querySelector(".accordion-header");
        const newHeader = header.cloneNode(true);
        header.parentNode.replaceChild(newHeader, header);

        const content = item.querySelector(".accordion-description");

        newHeader.addEventListener("click", () => {
          const isOpen = item.classList.contains("active");

          // 1. SIBLING LOGIC: Close others
          items.forEach(sibling => {
            if (sibling !== item && sibling.classList.contains("active")) {
              const siblingContent = sibling.querySelector(".accordion-description");
              
              // Apply special animation class
              siblingContent.classList.add("collapse-top-down");
              sibling.classList.remove("active");
              siblingContent.style.maxHeight = null;

              // Clean up class after animation
              setTimeout(() => {
                siblingContent.classList.remove("collapse-top-down");
              }, 400); 
            }
          });

          // 2. SELF LOGIC: Toggle normally
          if (isOpen) {
            // Close Self
            item.classList.remove("active");
            content.style.maxHeight = null;
          } else {
            // Open Self
            item.classList.add("active");
            content.style.maxHeight = content.scrollHeight + "px";

            // --- SMART SCROLL LOGIC ---
            // Only scroll IF the header has been pushed off-screen.
            
            setTimeout(() => {
              // Get current position of the clicked header
              const rect = item.getBoundingClientRect();
              
              // Define a "Safe Zone" at the top (e.g., for Sticky Headers)
              // 100px is usually safe. 0 would be the very top edge.
              const stickyHeaderOffset = 100; 

              // CHECK: Is the header ABOVE the safe zone?
              // rect.top is the distance from the top of the viewport.
              // If rect.top is negative (e.g. -50), it's hidden above.
              // If rect.top is less than our offset (e.g. 20), it's too close to the top.
              
              if (rect.top < stickyHeaderOffset) {
                // It is hidden or too high! Scroll it down.
                const absoluteTop = rect.top + window.pageYOffset;
                
                window.scrollTo({
                  top: absoluteTop - stickyHeaderOffset,
                  behavior: 'smooth'
                });
              } 
              // ELSE: If rect.top >= 100, we do NOTHING. The user sees it fine.

            }, 350); // Wait for the collapse animation (approx 350-400ms)
          }
        });
      });
    }

    // Initialize on Page Load
    document.addEventListener("DOMContentLoaded", function() {
      const sectionContainer = document.getElementById("Accordion-{{ section.id }}");
      initAccordion(sectionContainer);
    });

    // Initialize in Shopify Design Mode
    document.addEventListener("shopify:section:load", function(event) {
      if (event.detail.sectionId === "{{ section.id }}") {
        const sectionContainer = document.getElementById("Accordion-{{ section.id }}");
        initAccordion(sectionContainer);
      }
    });
  })();
</script>

{% schema %}
  {
    "name": "Accordion",
    "tag": "section",
    "class": "section accordion-list accordion-list-section",
    "settings": [
      {
        "type": "header",
        "content": "Section Spacing"
      },
      {
        "type": "paragraph",
        "content": "Settings apply to Mobile. Tablet scales by 1.5x, Desktop scales by 2x."
      },
      {
        "type": "range",
        "id": "margin_top_mobile",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "Margin Top (Mobile)",
        "default": 32
      },
      {
        "type": "range",
        "id": "margin_bottom_mobile",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "Margin Bottom (Mobile)",
        "default": 32
      }, {
        "type": "header",
        "content": "Content Settings"
      }, {
        "type": "text",
        "id": "title",
        "label": "Title"
      }, {
        "type": "textarea",
        "id": "description",
        "label": "Description"
      }, {
        "type": "color",
        "id": "heading_color",
        "label": "Heading Color",
        "default": "#6c7256"
      }, {
        "type": "header",
        "content": "Icon Settings"
      }, {
        "type": "html",
        "id": "custom_icon",
        "label": "Custom SVG Icon",
        "info": "Paste your SVG code here (e.g., <svg...>...</svg>). Leave blank to use the default Plus icon."
      }, {
        "type": "header",
        "content": "List Settings"
      }, {
        "type": "select",
        "id": "accordion_header_weight",
        "label": "Header Font Weight",
        "options": [
          {
            "value": "300",
            "label": "Light (300)"
          },
          {
            "value": "400",
            "label": "Normal (400)"
          },
          {
            "value": "500",
            "label": "Medium (500)"
          },
          {
            "value": "600",
            "label": "Semi-bold (600)"
          }, {
            "value": "700",
            "label": "Bold (700)"
          }, {
            "value": "800",
            "label": "Extra Bold (800)"
          }, {
            "value": "900",
            "label": "Black (900)"
          }
        ],
        "default": "500"
      }, {
        "type": "range",
        "id": "limit_count",
        "min": 1,
        "max": 20,
        "step": 1,
        "label": "Items to show initially",
        "default": 5
      }, {
        "type": "text",
        "id": "see_more_label",
        "label": "Expand Button Label",
        "default": "See More"
      }, {
        "type": "text",
        "id": "see_less_label",
        "label": "Collapse Button Label",
        "default": "See Less"
      }, {
        "type": "header",
        "content": "Button"
      }, {
        "type": "text",
        "id": "button_label",
        "label": "Button label"
      }, {
        "type": "url",
        "id": "button_url",
        "label": "Button url"
      }
    ],
    "blocks": [
      {
        "type": "text",
        "name": "List",
        "settings": [
          {
            "type": "text",
            "id": "title",
            "label": "Title"
          }, {
            "type": "richtext",
            "id": "description",
            "label": "Description"
          }, {
            "type": "color",
            "id": "accordion_text_color",
            "label": "Accordion Text Color",
            "default": "#567350"
          }
        ]
      }
    ],
    "presets": [
      {
        "name": "Accordion List"
      }
    ]
  }
{% endschema %}