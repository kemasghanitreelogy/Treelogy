<header class="header-nav">
  <div class="running-text announcement-slider-section">
    <div class="running-text-wrapper">
      <div id="announcement-slider" class="announcement-slider-container">

        {% comment %} {%- if section.blocks.size > 1 -%}
                    <button class="slider-arrow prev" aria-label="Previous announcement">
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    </button>
                {%- endif -%} {% endcomment %}

        <div class="slider-window">
          <div class="slider-track" id="slider-track">
            {% for block in section.blocks %}
              <div class="slide-text" data-index="{{ forloop.index0 }}">
                <a href="{{ block.settings.url | default : "#" }}">
                  {{ block.settings.title }}
                </a>
              </div>
            {% endfor %}
          </div>
        </div>
      {% comment %} 
                {%- if section.blocks.size > 1 -%}
                  <button class="slider-arrow next" aria-label="Next announcement">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                  </button>
              {%- endif -%} {% endcomment %}

      </div>
    </div>
  </div>
  <div class="header-menu">
    <div class="main-grid">
      <div class="burger item">
        <div class="burger-button" id="burger-button">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 22 17">
            <path
              fill="#2B3C35"
              fill-rule="evenodd"
              d="M11 .594H0v2.062h11V.594Zm5.5 6.875H0V9.53h16.5V7.47ZM0 14.344h22v2.062H0v-2.062Z"
              clip-rule="evenodd" />
          </svg>
        </div>
      </div>
      <div class="button button-search mobile" id="button-search">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 12 13">
          <path fill="#33423B" d="M12 11.794 8.873 8.667a5.002 5.002 0 1 0-.706.706l3.127 3.127.706-.706Zm-6.99-2.29a3.995 3.995 0 1 1 0-7.99 3.995 3.995 0 0 1 0 7.99Z" />
        </svg>
      </div>
      <div class="logo item">
        <a href="{{ request.locale.root_url }}">
          {% render 'Image'
            , image: section.settings.logo %}
        </a>
      </div>
      <div class="right-menu item">
        <script>
          {% assign variants =  settings.free_product.variants | first %}
          window.bonusItems = [
            {
              name: '{{ settings.free_shipping_info }}',
              active: {{ settings.active_free_shipping_progress }},
              minCheckout: {{ settings.min_shipping | default: 0 }},
              icon: "{%-  if  settings.bonus_2_icon -%}{{ settings.bonus_1_icon | image_url: width: 100, height:  100}}{%- endif -%}",
              countries: '{{ settings.shipping_selected_country | downcase | replace: " ", ""}}'
            },

            {
              name: '{{ settings.free_product_info }}',
              active: {{ settings.active_free_product }},
              minCheckout: {{ settings.min_free_product_checkout | default: 0 }},
              freeProduct: '{{ variants.id }}',
              icon: "{%-  if  settings.bonus_2_icon -%}{{ settings.bonus_2_icon | image_url: width: 100, height:  100}}{%- endif -%}",
              countries: '{{ settings.free_product_selected_country | downcase | replace: " ", "" }}'
            }
          ]


          window.activeCountryCode = Shopify.country.toLowerCase();
          window.activeFreeProduct = null;
          window.activeFreeProductDetailInfo = '{{ settings.free_product_info }}'

          window.customCompleteText = '{{ settings.complete_text }}';

          const haveUserCauntry = localStorage.getItem('_userCountry')

          if(haveUserCauntry) {
            window.activeCountryCode = haveUserCauntry;
              if({{ settings.active_free_product }}) {
                window.activeFreeProduct = '{{ variants.id }}';
              }
          }else{
            fetch('https://ipapi.co/json/')
            .then((response) => response.json())
            .then((data) => {
              window.activeCountryCode = data.country.toLowerCase();

              if({{ settings.active_free_product }}) {
                window.activeFreeProduct = '{{ variants.id }}';
              }

              localStorage.setItem('_userCountry', data.country.toLowerCase())

            })
          }
        </script>

        {% render 'HeaderMenuIcon' %}
      </div>
    </div>
  </div>
</header>

<div class="header-popup header-nav">
  <div class="header-menu">
    <div class="main-grid">
      <div class="burger item">
        <div class="burger-button" id="close-menu-button">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 12 12">
            <path fill="#F8F8F2" d="M12 1.265 10.735 0 6 4.735 1.265 0 0 1.265 4.735 6 0 10.735 1.265 12 6 7.265 10.735 12 12 10.735 7.265 6 12 1.265Z" />
          </svg>
        </div>
      </div>
      <div class="logo item">
        <a href="{{ request.locale.root_url }}">
          {% render 'Image'
            , image: section.settings.logo %}
        </a>
      </div>
      <div class="right-menu item">
        {% render 'HeaderMenuIcon' %}
      </div>
    </div>
  </div>
  <div class="header-inner">
    <div class="main-grid">
      {% render 'MainNavigation'
        , menu: section.settings.main_menu %}
      <div class="header-selector">
        {% comment %}
          {% render 'CountrySelector' %}
          {% render 'CurrencySelector' %}
        {% endcomment %}
      </div>
      {% if section.settings.header_product != null %}
        <div class="featured-header-product" data-cs-capture>
          <div class="h2 heading desktop">{{ 'products.featured.title' | t }}</div>
          {% render 'ProductCard'
            , item: section.settings.header_product
            , button_cart: true %}
        </div>
      {% endif %}
    </div>
  </div>
</div>
<div id="country-code"></div>

<style>
  #country-code {
    position: fixed;
    top: 10px;
    right: 20px;
    pointer-events: none;
    font-size: 11px;
    color: #fff;
    border-radius: 10px;
    padding: 0 10px;
    z-index: 9999999;
    text-transform: uppercase;
    background-color: rgba(0, 0, 0, 0.9);
  }

  /* --- SLIDER STYLES (SLIDING EFFECT) --- */

  .announcement-slider-section {
    background-color: #000;
    /* Dark Background */
    color: #ffffff !important;
    width: 100%;
    display: block;
  }

  .running-text-wrapper {
    width: 100%;
    margin: 0 auto;
  }

  .announcement-slider-container {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    position: relative;
    padding: 10px 0;
    min-height: 40px;
    /* Prevent default touch actions like scroll when swiping horizontally */
    touch-action: pan-y;
  }

  /* The Window (Mask) that hides overflowing slides */
  .slider-window {
    flex-grow: 1;
    overflow: hidden;
    max-width: 800px;
    position: relative;
    display: flex;
    align-items: center;
  }

  /* The Track that moves horizontally */
  .slider-track {
    display: flex;
    width: 100%;
    align-items: center;
    will-change: transform;
  }

  /* Individual Slide */
  .slide-text {
    min-width: 100%;
    flex: 0 0 100%;
    text-align: center;
    box-sizing: border-box;
    padding: 0 5px;
    user-select: none;
    /* Prevent text selection during swipe */
  }

  .slide-text a {
    text-decoration: none;
    color: #ffffff !important;
    font-size: 12px;
    display: block;
    width: 100%;
    /* Ensure the link area captures touch */
    pointer-events: auto;
  }

  /* Navigation Arrows */
  .slider-arrow {
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 15px;
    color: #ffffff !important;
    opacity: 0.7;
    transition: opacity 0.3s;
    z-index: 5;
    flex-shrink: 0;
  }

  .slider-arrow:hover {
    opacity: 1;
  }

  .slider-arrow svg {
    stroke: #ffffff;
  }

</style>
<script>
  window.country_progress_selection = '{{ settings.shipping_selected_country | downcase }}';
  window.country_progress_is_active = {{ settings.active_free_shipping_progress | default: false}};

  // --- INFINITE SLIDING & AUTO-SLIDE LOGIC ---
  document.addEventListener("DOMContentLoaded", function() {
    const searchInput = document.getElementById('search-input');
  const upsellBlock = document.getElementById('search-upsell-block');
  const searchResults = document.querySelector('.search-results');

  if (searchInput && upsellBlock) {
    searchInput.addEventListener('input', function(e) {
      const query = e.target.value.trim();

      if (query.length > 0) {
        // User is typing: Hide Upsell
        upsellBlock.style.display = 'none';
      } else {
        // Input is empty: Show Upsell, Clear Results
        upsellBlock.style.display = 'block';
        if(searchResults) searchResults.innerHTML = ''; 
      }
    });
  }
    const track = document.getElementById('slider-track');
    const container = document.getElementById('announcement-slider'); // Main container
    if (!track || !container) return;

    // Get original slides
    const originalSlides = track.querySelectorAll('.slide-text');
    const nextBtn = document.querySelector('.slider-arrow.next');
    const prevBtn = document.querySelector('.slider-arrow.prev');
    
    const totalOriginalSlides = originalSlides.length;

    // Only run if we have more than 1 slide
    if (totalOriginalSlides > 1) {
      
      // 1. CLONE SLIDES FOR INFINITE EFFECT
      const firstClone = originalSlides[0].cloneNode(true);
      firstClone.id = 'first-clone';
      
      const lastClone = originalSlides[totalOriginalSlides - 1].cloneNode(true);
      lastClone.id = 'last-clone';

      track.appendChild(firstClone);
      track.insertBefore(lastClone, originalSlides[0]);

      // 2. INITIAL SETUP
      let currentIndex = 1;
      const allSlides = track.querySelectorAll('.slide-text');
      
      // Position track at real first slide (no animation initially)
      track.style.transform = `translateX(-100%)`;

      let isAnimating = false;
      let slideInterval;
      const intervalTime = 3000; // 3000ms = 3 seconds

      // Swipe Variables
      let touchStartX = 0;
      let touchEndX = 0;

      const moveSlide = () => {
        track.style.transition = 'transform 0.5s ease-in-out';
        track.style.transform = `translateX(-${currentIndex * 100}%)`;
      };

      const goToNext = () => {
        if (isAnimating) return;
        if (currentIndex >= allSlides.length - 1) return;
        
        isAnimating = true;
        currentIndex++;
        moveSlide();
      };

      const goToPrev = () => {
        if (isAnimating) return;
        if (currentIndex <= 0) return;

        isAnimating = true;
        currentIndex--;
        moveSlide();
      };

      // 3. AUTO SLIDE FUNCTIONS
      const startAutoSlide = () => {
        clearInterval(slideInterval); // Clear first to avoid duplicates
        slideInterval = setInterval(goToNext, intervalTime);
      };

      const stopAutoSlide = () => {
        clearInterval(slideInterval);
      };

      // 4. EVENT LISTENERS FOR BUTTONS
      if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          stopAutoSlide();
          goToNext();
        });
      }

      if (prevBtn) {
        prevBtn.addEventListener('click', () => {
          stopAutoSlide();
          goToPrev();
        });
      }

      // 5. PAUSE ON HOVER (DESKTOP)
      container.addEventListener('mouseenter', stopAutoSlide);
      container.addEventListener('mouseleave', startAutoSlide);

      // 6. TOUCH SWIPE LOGIC
      
      const handleGesture = () => {
        // Threshold: minimum distance (px) to register as a swipe
        const threshold = 30; 
        
        // Calculate difference
        if (touchEndX < touchStartX - threshold) {
          // Swiped Left -> Go Next
          goToNext();
        } else if (touchEndX > touchStartX + threshold) {
          // Swiped Right -> Go Prev
          goToPrev();
        }
      };

      container.addEventListener('touchstart', (e) => {
        stopAutoSlide();
        touchStartX = e.changedTouches[0].screenX;
      }, { passive: true });

      container.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        handleGesture();
        startAutoSlide();
      });

      // 7. RESET POSITION ON TRANSITION END
      track.addEventListener('transitionend', () => {
        isAnimating = false;

        // If at the end (Clone of First Slide) -> Jump to Real First Slide
        if (allSlides[currentIndex].id === 'first-clone') {
          track.style.transition = 'none';
          currentIndex = 1;
          track.style.transform = `translateX(-${currentIndex * 100}%)`;
        }

        // If at the start (Clone of Last Slide) -> Jump to Real Last Slide
        if (allSlides[currentIndex].id === 'last-clone') {
          track.style.transition = 'none';
          currentIndex = allSlides.length - 2;
          track.style.transform = `translateX(-${currentIndex * 100}%)`;
        }
      });

      // 8. START AUTO SLIDE ON LOAD
      startAutoSlide();
    }
  });
</script>

{% render 'SearchInput' %}

{% render 'MiniCart'
  , up_selling: section.settings.up_selling_products %}

{% render 'PopupVariants'
  , product: section.settings.header_product %}

{% schema %}
  {
    "name": "Header",
    "settings": [
      {
        "type": "image_picker",
        "id": "logo",
        "label": "Logo"
      },

      {
        "type": "product",
        "id": "header_product",
        "label": "Featured Product"
      },
      {
        "type": "link_list",
        "id": "main_menu",
        "label": "Main Menu"
      },
      {
        "type": "header",
        "content": "Cart"
      }, {
        "type": "product_list",
        "id": "up_selling_products",
        "label": "Up Selling Products"
      }, {
        "type": "header",
        "content": "Cart Sidebar Settings"
      }
    ],
    "blocks": [
      {
        "limit": 5,
        "type": "text",
        "name": "Runing Text",
        "settings": [
          {
            "type": "text",
            "id": "title",
            "label": "Title"
          }, {
            "type": "url",
            "id": "url",
            "label": "Link to"
          }
        ]
      }
    ]
  }
{% endschema %}