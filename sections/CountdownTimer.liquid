<div
  class="countdown-section countdown-container"
  id="countdown-{{ section.id }}"
  style="color: {{ section.settings.text_color }};">
  <div class="countdown-wrapper">
    <div class="countdown-item">
      <div class="countdown-label">{{ section.settings.label_days }}</div>
      <div class="countdown-value" data-days>00</div>
    </div>
    <div class="countdown-item">
      <div class="countdown-label">{{ section.settings.label_hours }}</div>
      <div class="countdown-value" data-hours>00</div>
    </div>
    <div class="countdown-item">
      <div class="countdown-label">{{ section.settings.label_minutes }}</div>
      <div class="countdown-value" data-minutes>00</div>
    </div>
  </div>

  {% if section.settings.description != blank %}
    <div class="countdown-description">
      {{ section.settings.description }}
    </div>
  {% endif %}

  {% if section.settings.footer_text != blank %}
    <div class="countdown-footer">
      {{ section.settings.footer_text }}
    </div>
  {% endif %}
</div>

<style>
  #countdown-{{ section.id }} {
    /* Mobile margins */
    margin-top: {{ section.settings.margin_top }}px;
    margin-bottom: {{ section.settings.margin_bottom }}px;
  }

  /* Tablet margins */
  @media (min-width: 768px) {
    #countdown-{{ section.id }} {
      margin-top: {{ section.settings.margin_top | times: 1.3 | round }}px;
      margin-bottom: {{ section.settings.margin_bottom | times: 1.3 | round }}px;
    }
  }

  /* Desktop margins */
  @media (min-width: 1024px) {
    #countdown-{{ section.id }} {
      margin-top: {{ section.settings.margin_top | times: 1.6 | round }}px;
      margin-bottom: {{ section.settings.margin_bottom | times: 1.6 | round }}px;
    }
  }

</style>

<script>
  (function() {
    // Use section.id to create unique scope
    const sectionId = 'countdown-{{ section.id }}';
    const section = document.getElementById(sectionId);
    
    if (!section) return;
    
    // The target date string from the new setting (Format: YYYY-MM-DD HH:MM)
    const targetDateString = '{{ section.settings.target_datetime }}'; 
    
    // Convert the date string into a Unix timestamp (milliseconds)
    const endTime = Date.parse(targetDateString);
    
    // Check if the date string was invalid
    if (isNaN(endTime)) {
        console.error(`Countdown Timer (ID: {{ section.id }}): Invalid target date format: ${targetDateString}`);
        return;
    }

    // Query within the specific section only
    const days = section.querySelector('[data-days]');
    const hours = section.querySelector('[data-hours]');
    const minutes = section.querySelector('[data-minutes]');
    
    function pad(n) {
      return n < 10 ? '0' + n : n;
    }
    
    function update() {
      const now = Date.now();
      // Calculate the difference in milliseconds
      const diff = endTime - now;
      
      if (diff <= 0) {
        days.textContent = '00';
        hours.textContent = '00';
        minutes.textContent = '00';
        // Stop the interval when the countdown is finished
        clearInterval(interval); 
        return;
      }
      
      // Constants for time unit conversion in milliseconds
      const MS_PER_DAY = 86400000;
      const MS_PER_HOUR = 3600000;
      const MS_PER_MINUTE = 60000;
      
      // Calculate remaining time
      const d = Math.floor(diff / MS_PER_DAY);
      const h = Math.floor((diff % MS_PER_DAY) / MS_PER_HOUR);
      const m = Math.floor((diff % MS_PER_HOUR) / MS_PER_MINUTE);
      
      days.textContent = pad(d);
      hours.textContent = pad(h);
      minutes.textContent = pad(m);
    }
    
    // Initial call and set interval
    update();
    const interval = setInterval(update, 1000);
    
    // Optional: Clean up interval if section is removed (for theme editor)
    if (Shopify && Shopify.designMode) {
      document.addEventListener('shopify:section:unload', function(event) {
        if (event.detail.sectionId === '{{ section.id }}') {
          clearInterval(interval);
        }
      });
    }
  })();
</script>

{% schema %}
  {
    "name": "Countdown Timer",
    "settings": [
      {
        "type": "text",
        "id": "target_datetime",
        "label": "Countdown Target Date/Time",
        "default": "2025-12-31 23:59",
        "info": "Format: YYYY-MM-DD HH:MM (e.g., 2025-12-31 23:59). Time is relative to the viewer's device clock."
      },
      {
        "type": "text",
        "id": "label_days",
        "label": "Label for Days",
        "default": "DAYS"
      },
      {
        "type": "text",
        "id": "label_hours",
        "label": "Label for Hours",
        "default": "HOURS"
      },
      {
        "type": "text",
        "id": "label_minutes",
        "label": "Label for Minutes",
        "default": "MINUTES"
      }, {
        "type": "richtext",
        "id": "description",
        "label": "Description",
        "default": "<p>* Required Field. Public access begins Dec 12. Private access opens Dec 9 at 10:00 AM WIB.</p>"
      }, {
        "type": "richtext",
        "id": "footer_text",
        "label": "Footer Text",
        "default": "<p>By submitting this form, you agree to receive Treelogy updates and marketing messages by email or WhatsApp. Consent is not a condition of purchase. You can unsubscribe at any time by replying STOP or using the link provided. Our Privacy Policy and Terms apply.</p>"
      }, {
        "type": "header",
        "content": "Styling"
      }, {
        "type": "color",
        "id": "text_color",
        "label": "Text Color",
        "default": "#000000"
      }, {
        "type": "range",
        "id": "margin_top",
        "min": 0,
        "max": 200,
        "step": 10,
        "unit": "px",
        "label": "Margin Top",
        "default": 0
      }, {
        "type": "range",
        "id": "margin_bottom",
        "min": 0,
        "max": 200,
        "step": 10,
        "unit": "px",
        "label": "Margin Bottom",
        "default": 0
      }
    ],
    "presets": [
      {
        "name": "Countdown Timer"
      }
    ]
  }
{% endschema %}

{% stylesheet %}

  .countdown-container {
    padding: 0 40px;
  }
  .countdown-section{
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    max-width: 500px;
    margin: auto;
  }

  .countdown-section .countdown-wrapper {
    display: flex;
    justify-content: space-between;
    width: 100%;
    padding: 0 30px 18px;
    flex-wrap: wrap;
    text-align: center;
  }


  .countdown-section .countdown-label {
    font-size: 12px;
    font-weight: 400;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  .countdown-section .countdown-value {
    font-size: 14px;
    font-weight: 500;
    line-height: 1;
  }

  .countdown-section .countdown-description {
    max-width: 800px;
    margin: 0 auto 20px;
    font-size: 12px;
    line-height: 1.6;
    font-weight: 300;
    padding: 0 30px;
  }

  .countdown-section .countdown-footer {
    max-width: 900px;
    margin: 0 auto;
    font-size: 9px;
    line-height: 1.6;
    font-weight: 300;
  }

  @media (min-width: 768px) {
    .countdown-section .countdown-wrapper {
      gap: 20px;
    }

    .countdown-section .countdown-item {
      min-width: 80px;
    }

    .countdown-section .countdown-description {
      font-size: 14px;
    }
    .countdown-section .countdown-footer {
      font-size: 13px;
    }

    .countdown-section .countdown-value {
      font-size: 36px;
    }

    .countdown-section .countdown-label {
      font-size: 12px;
    }
  }

  /* TABLET: scale 1.3 */
  @media (min-width: 768px) {
    .countdown-section .countdown-label {
      font-size: calc(12px * 1.3);
    }
    .countdown-section .countdown-value {
      font-size: calc(14px * 1.3);
    }
    .countdown-section .countdown-description {
      font-size: calc(12px * 1.3);
    }
    .countdown-section .countdown-footer {
      font-size: calc(9px * 1.3);
    }
  }

  /* DESKTOP: scale 1.6 */
  @media (min-width: 1024px) {
    .countdown-section .countdown-label {
      font-size: calc(12px * 1.6);
    }
    .countdown-section .countdown-value {
      font-size: calc(14px * 1.6);
    }
    .countdown-section .countdown-description {
      font-size: calc(12px * 1.6);
    }
    .countdown-section .countdown-footer {
      font-size: calc(9px * 1.6);
    }
  }
{% endstylesheet %}