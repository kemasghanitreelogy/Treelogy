{% assign selected_product = all_products[section.settings.feature_product] %}
{% assign selected_bundle = selected_product.metafields.bundle_set.value %}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top }}px;
    max-width: 1100px;
    margin-left: auto;
    margin-right: auto;
    padding-bottom: {{ section.settings.padding_bottom }}px;
  }
  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top | times: 2 }}px;
      padding-bottom: {{ section.settings.padding_bottom | times: 2 }}px;
    }
  }
  .featured-bundle-section .description {
    padding-right: 0;
  }
  .inside-set-wrapper p {
    font-weight: 600;
  }
  .inside-set-content.rte ul {
    list-style: none;
    padding-left: 0;
  }
  .inside-set-content.rte li {
    display: flex;
    align-items: flex-start;
    gap: 6px;
  }
  .inside-set-content.rte li::before {
    content: "â€¢";
    font-size: 1.2em;
    line-height: 1;
  }

  .featured-bundle-section .gallery-wrapper {
    transform: translateX(24px);
  }
  .featured-bundle-section .product-detail-wrapper {
    display: flex;
    flex-direction: column;
  }
  .bundle-gallery-grid {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }
  .featured-bundle-section .section-heading {
    padding: 0 24px;
    color: #6c7256;
  }

  @media screen and (min-width: 749px) {
    .featured-bundle-section .section-heading {
      text-align: center;
      margin-bottom: 40px;
    }
  }

  .main-image-display {
    width: 100%;
    position: relative;
    border-radius: 8px;
    overflow: hidden;
  }

  .main-image-display img {
    width: 100%;
    height: auto;
    display: none;
    object-fit: cover;
    aspect-ratio: 1 / 1;
  }

  .main-image-display img.activeBundle {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  .slider-row {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  .slider-row::-webkit-scrollbar {
    display: none;
  }

  .slider-item {
    flex-shrink: 0;
    cursor: pointer;
    border-radius: 6px;
    overflow: hidden;
    position: relative;
    border: 2px solid transparent;
    transition: border-color 0.2s;
    scroll-snap-align: start;
  }

  .slider-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .slider-item.activeBundle {
    border-color: #000;
  }

  @media screen and (max-width: 749px) {
    .main-image-display {
      display: none;
    }

    .slider-row {
      gap: 3px;
      padding-right: 20px;
    }

    .slider-item {
      height: auto;
      aspect-ratio: 4 / 5;
    }
    .slider-item.activeBundle {
      border-color: transparent;
    }

    .slider-item {
      width: 55%;
      height: 190px;
    }
  }

  @media screen and (min-width: 750px) {
    .featured-bundle-section .product-detail-wrapper {
      flex-direction: row;
      column-gap: 40px;
    }
    .slider-item {
      width: 80px;
      height: 80px;
    }
    .slider-item:first-child {
      width: 80px;
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0.5;
    }
    to {
      opacity: 1;
    }
  }
{%- endstyle -%}

{% if selected_product == blank %}
  <div class="page-width" style="text-align: center; padding: 50px;">
    <p>Please select a product in the theme editor.</p>
  </div>
{% else %}

  {% assign current_variant = selected_product.selected_or_first_available_variant %}

  {% for variant in selected_product.variants %}
    {% if variant.metafields.custom.set_default == true %}
      {% assign current_variant = variant %}
      {% break %}
    {% endif %}
  {% endfor %}

  <div class="featured-bundle-section section-{{ section.id }} page-width section-{{ section.id }}-padding">
    {% if section.settings.heading != blank %}
      <h2 class="section-heading text-center">{{ section.settings.heading }}</h2>
    {% endif %}

    <div class="bundle-grid product-detail-wrapper">

      <div class="gallery-wrapper">
        <div id="bundle-gallery-wrapper-{{ section.id }}" class="bundle-gallery-grid">
          <div class="main-image-display">
            {% for image in selected_product.images limit: 5 %}
              <img
                src="{{ image.src | img_url: '1000x' }}"
                alt="{{ image.alt | escape }}"
                data-index="{{ forloop.index0 }}"
                class="{% if forloop.first %}activeBundle{% endif %}">
            {% endfor %}
          </div>
          <div class="slider-row">
            {% for image in selected_product.images limit: 5 %}
              <div class="slider-item {% if forloop.first %}activeBundle{% endif %}" data-index="{{ forloop.index0 }}">
                <img src="{{ image.src | img_url: '600x' }}" alt="{{ image.alt | escape }}">
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      {% comment %} DETAILS {% endcomment %}
      <div class="detail bundle-details">
        <div class="rating">
          {% render 'Rating' %}
        </div>

        <h1>{{ selected_product.title }}</h1>
        <div class="description body-desk">
          {{ selected_product.description }}
          {% assign inside_set = selected_product.metafields.custom.inside_set %}
          {% if inside_set != blank %}
            <div class="inside-set-wrapper">
              <p>Inside the Set</p>
              <div class="inside-set-content rte">
                {{ inside_set | metafield_tag }}
              </div>
            </div>
          {% endif %}
        </div>

        <div class="bundle-purchase-area mt-8">
          <form
            action="/cart/add"
            method="post"
            enctype="multipart/form-data"
            id="AddToCartForm-{{ section.id }}">

            <div class="variant-button" id="VariantContainer-{{ section.id }}">
              {% if selected_product.has_only_default_variant == false %}
                {% render 'VariantsButton'
                  , product: selected_product
                  , is_not_option: true
                  , current_variant: current_variant
                %}
              {% endif %}
            </div>

            <select
              name="id"
              id="RealProductSelect-{{ section.id }}"
              style="display: none;">
              {% for variant in selected_product.variants %}
                <option
                  value="{{ variant.id }}"
                  data-available="{{ variant.available }}"
                  {% if variant.id == current_variant.id %}
                  selected="selected"
                  {% endif %}>
                  {{ variant.title }}
                </option>
              {% endfor %}
            </select>

            <input
              type="hidden"
              name="quantity"
              value="1">

            <button
              type="submit"
              name="add"
              id="AddToCartBtn-{{ section.id }}"
              class="button AddToCartBtn button--full-width button--primary mt-4"
              {% unless current_variant.available %}
              disabled
              {% endunless %}>
              {% if current_variant.available %}Add to Cart{% else %}Sold Out{% endif %}
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // 0. CONFIG
      const sectionId = "{{ section.id }}";
      const bundleContainer = document.querySelector(`.section-${sectionId}`);
      const variantContainer = document.getElementById(`VariantContainer-${sectionId}`);
      const realSelect = document.getElementById(`RealProductSelect-${sectionId}`);
      const cartBtn = document.getElementById(`AddToCartBtn-${sectionId}`);

      if (variantContainer && realSelect) {
        const buttons = variantContainer.querySelectorAll('.checkbox-button');

        // ========================================================
        // 1. FUNCTION: FORCE ACTIVE STATE (Fixes Double Click)
        // ========================================================
        function setActiveButton() {
           const initialValue = realSelect.value;
           if(!initialValue) return;

           const targetBtn = variantContainer.querySelector(`.checkbox-button[data-value="${initialValue}"]`);
           if(targetBtn) {
             // Clean Slate
             buttons.forEach(b => b.classList.remove('active'));
             // Force Add
             targetBtn.classList.add('active');
           }
        }

        // Run Immediately to sync Liquid state with JS state
        setActiveButton();
        // Run again shortly after to beat any Theme JS interference
        setTimeout(setActiveButton, 100);


        // ========================================================
        // 2. CLICK LISTENERS
        // ========================================================
        buttons.forEach(btn => {
          btn.addEventListener('click', function(e) {
            
            // UI Update: Remove active from all, add to this
            buttons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Data Update
            const variantId = this.getAttribute('data-value');
            const isAvailable = this.getAttribute('data-available') === 'true';
            
            realSelect.value = variantId;
            
            // Stock Update
            if (isAvailable) {
              cartBtn.textContent = "Add to Cart";
              cartBtn.disabled = false;
            } else {
              cartBtn.textContent = "Sold Out";
              cartBtn.disabled = true;
            }

            // Gift Update
            const giftContainer = bundleContainer.querySelector(`.gift-products`);
            if (giftContainer) {
               const gifts = giftContainer.querySelectorAll('.product');
               gifts.forEach(g => g.classList.remove('active')); 
               const activeGift = document.getElementById(`gift-${variantId}`);
               if (activeGift) activeGift.classList.add('active');
            }
          });
        });
      }

      // ============================================
      // GALLERY LOGIC (Using 'active')
      // ============================================
      if (window.innerWidth > 749) {
        const wrapper = document.getElementById(`bundle-gallery-wrapper-${sectionId}`);
        if(wrapper) {
            const thumbs = wrapper.querySelectorAll('.slider-item');
            const mains = wrapper.querySelectorAll('.main-image-display img');

            thumbs.forEach(t => {
                t.addEventListener('click', function(e) {
                    e.preventDefault();
                    thumbs.forEach(i => i.classList.remove('active'));
                    mains.forEach(i => i.classList.remove('active'));
                    
                    this.classList.add('active');
                    const idx = this.getAttribute('data-index');
                    
                    const target = wrapper.querySelector(`.main-image-display img[data-index="${idx}"]`);
                    if(target) target.classList.add('active');
                });
            });
        }
      }

      // ============================================
      // VISIBILITY LOGIC (Fixes Double Click in Filter)
      // ============================================
      function updateBundleVisibility(targetId) {
        if (!variantContainer) return;
        const buttons = variantContainer.querySelectorAll('.checkbox-button');
        
        buttons.forEach(btn => {
          const btnId = btn.getAttribute('data-value');
          if (!targetId) {
            btn.style.display = ''; 
          } else {
            if (btnId === targetId) {
              btn.style.display = ''; 
              // Directly set class instead of simulating click
              if (!btn.classList.contains('active')) {
                 buttons.forEach(b => b.classList.remove('active'));
                 btn.classList.add('active');
                 if(realSelect) realSelect.value = btnId;
              }
            } else {
              btn.style.display = 'none'; 
            }
          }
        });
      }

      // ============================================
      // EVENTS & STORAGE
      // ============================================
      window.addEventListener('custom-variant-change', function(e) {
        updateBundleVisibility(e.detail.targetId);
      });

      const storedId = sessionStorage.getItem('target_bundle_id');
      if (storedId) {
         updateBundleVisibility(storedId);
      }

      // ============================================
      // AJAX ADD TO CART
      // ============================================
      if (cartBtn) {
        const textAdding = "{{ 'products.product.adding' | t | default: 'Adding...' }}";
        const textError = "{{ 'products.product.error' | t | default: 'Error' }}";

        cartBtn.addEventListener('click', function(e) {
          e.preventDefault();
          const variantId = realSelect ? realSelect.value : null;
          if (!variantId) return;

          this.innerHTML = textAdding;
          this.style.opacity = '0.7';

          let formData = { 'items': [{ 'id': variantId, 'quantity': 1 }] };

          fetch(window.Shopify.routes.root + 'cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          })
          .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
          })
          .then(data => {
            this.innerHTML = "Item Added!"; 
            this.style.opacity = '1';
            setTimeout(() => { this.innerHTML = "Add to Cart"; }, 2000);
            
            const cartIcon = document.querySelector('a[href="/cart"]') || document.querySelector('.header__icon--cart');
            if (cartIcon) {
              cartIcon.click();
            } else {
              document.documentElement.dispatchEvent(new CustomEvent('cart:refresh', { bubbles: true }));
              document.documentElement.dispatchEvent(new CustomEvent('cart:open', { bubbles: true })); 
            }
            
            // Update Cart Count
            const cartBubble = document.querySelectorAll('.cart-count-bubble span, .header__cart-count');
            cartBubble.forEach(el => {
                let currentCount = parseInt(el.innerText || 0);
                el.innerText = currentCount + 1;
            });
          })
          .catch((error) => {
            this.innerHTML = textError;
            this.style.opacity = '1';
            setTimeout(() => { this.innerHTML = "Add to Cart"; }, 2000);
          });
        });
      }

    });
  </script>
{% endif %}

{% schema %}
  {
    "name": "Featured Bundle",
    "tag": "section",
    "class": "section",
    "settings": [
      {
        "type": "product",
        "id": "feature_product",
        "label": "Featured Product (The Bundle)"
      }, {
        "type": "textarea",
        "id": "heading",
        "label": "Heading textarea",
        "default": "Complete Your Set"
      }, {
        "type": "range",
        "id": "padding_top",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "Padding Top",
        "default": 36
      }, {
        "type": "range",
        "id": "padding_bottom",
        "min": 0,
        "max": 100,
        "step": 4,
        "unit": "px",
        "label": "Padding Bottom",
        "default": 36
      }
    ],
    "presets": [
      {
        "name": "Featured Bundle"
      }
    ]
  }
{% endschema %}