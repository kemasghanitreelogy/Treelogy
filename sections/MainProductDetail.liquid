{% assign product_detail = product.metafields.custom.product_detail %}
{% assign product_detail = blank %}

<div class="main-grid product-detail-wrapper" data-cs-capture>
  <div class="gallery-wrapper">
    <div id="product-geallery-wrapper">
      <div class="media-gallery-custom sticky">
        {% for image in product.images %}

          {% assign image_alt = image.alt | escape %}

          {% if image.alt contains 'LANG:' %}
            {% assign image_alt = image.alt | split: "|" | last %}
            {% assign language_code = image.alt | split: "|" | first | remove: "LANG:" | downcase %}

            {% if language_code != request.locale.iso_code %}
              {% continue %}
            {% endif %}
          {% endif %}

          <a href="{{ image.src | img_url: '1440x' }}">
            <img src="{{ image. src | img_url: 'compact' }}" alt="{{ image.alt | escape }}">
          </a>
        {% endfor %}
      </div>
      <div class="main-image sticky">
        <div class="wrapper">
          <div class="main-image-wrapper-custom">
            {% for image in product.images %}
              {% assign image_alt = image.alt | escape %}

              {% if image.alt contains 'LANG:' %}
                {% assign image_alt = image.alt | split: "|" | last %}
                {% assign language_code = image.alt | split: "|" | first | remove: "LANG:" | downcase %}

                {% if language_code != request.locale.iso_code %}
                  {% continue %}
                {% endif %}
              {% endif %}

              <img src="{{ image.src | img_url: '1440x' }}" alt="{{ image_alt  }}">

            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  {% assign free_product = settings.free_product.id %}

  <div class="detail" id="product-detail-content">
    <div class="rating body-mobile">
      {% if product.metafields.custom.rating %}
        <div>
          {% render 'StarReview' %}
          <span class="rating-text">{{ product.metafields.custom.rating }}</span>
        </div>
      {% else %}
        {% render 'Rating' %}
      {% endif %}
    </div>

    <h1>{{ product.title }}</h1>
    {% render 'ProductTags' %}
    {% render 'ProductVideos' %}
    <div class="body-desk description">
      <div>{{ product.description }}</div>
      <div>
        {% assign rich_text_data = product.metafields.custom.advantage %}

        {% if rich_text_data != blank %}
          <div class="rich-text-container">
            {{ rich_text_data | metafield_tag }}
          </div>
        {% endif %}
      </div>
    </div>
    <div class="variant-button">
      {% if free_product != product.id %}
        {% render 'VariantsButton'
          , product: product %}
      {% endif %}
    </div>

    {% if free_product != product.id %}
      <form
        action="/cart/add"
        method="post"
        enctype="multipart/form-data"
        id="AddToCartForm">
        <select name="id" id="productSelect">
          {% for variant in product.variants %}
            {% if variant.available %}
              <option value="{{ variant.id }}">{{ variant.title }} - {{ variant.price | money_with_currency }}</option>
            {% else %}
              <option disabled="disabled">{{ variant.title }} - sold out</option>
            {% endif %}
          {% endfor %}
        </select>

        {% assign default_variant = product.variants[0].id %}

        {% for variant in product.variants %}
          {% assign set_default_varaint = variant.metafields.custom.set_default %}

          {%- if set_default_varaint -%}
            {% assign default_variant = variant.id %}
          {%- endif -%}
        {% endfor %}

        <input
          type="hidden"
          id="Quantity"
          name="quantity"
          value="1"
          min="1"
          max="1">
        <button
          data-variant="{{ default_variant }}"
          type="submit"
          class="button button-quick-add-cart"
          name="add"
          id="AddToCart">
          {{ 'products.general.add_to_cart' | t }}
        </button>
      </form>
    {% endif %}
    {% if product_detail.value.count > 0 %}
      <div class="product-detail-wrapper__list-description __accordion">
        {% for item in product_detail.value %}
          <div class="item __accordion-wrapper">
            <div class="button h3 __accordion-button">
              {{ item.title }}
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 12 12">
                <path fill="#2B3C35" d="M7 5V0H5v5H0v2h5v5h2V7h5V5H7Z" />
              </svg>
            </div>
            <div class="description __accordion-content">
              {{ item.description | metafield_tag }}
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
    <div class="payment">
      <div class="payment-title">{{ section.settings.payment_title }}</div>
      <div class="payment-image desktop">
        {% render 'Image'
          , image: section.settings.payment_list %}
      </div>
      <div class="payment-image mobile">
        {% assign mobile_image = section.settings.payment_list_mob | default: section.settings.payment_list %}
        {% render 'Image'
          , image: mobile_image %}
      </div>
    </div>
  </div>

</div>


{% schema %}
  {
    "name": "Product single",
    "tag": "section",
    "class": "section",
    "settings": [
      {
        "type": "text",
        "id": "payment_title",
        "label": "Payments title"
      },
      {
        "type": "image_picker",
        "id": "payment_list",
        "label": "Payments image desktop"
      },

      {
        "type": "image_picker",
        "id": "payment_list_mob",
        "label": "Payments image mobile"
      },

      {
        "type": "header",
        "content": "Note"
      }, {
        "type": "text",
        "id": "note",
        "label": "Note"
      }, {
        "type": "image_picker",
        "id": "note_image",
        "label": "Note image"
      }
    ],

    "presets": [
      {
        "name": "Product single"
      }
    ]
  }
{% endschema %}

<script>
  document.addEventListener("DOMContentLoaded", function() {

    // ==================================================
    // 1. DATA SOURCE: VARIANT & METAFIELD MAP
    // ==================================================
    const mainProductData = {};
    
    {% for variant in product.variants %}
      {% assign linked_variant = variant.metafields.custom.product_integration.value %}
      mainProductData["{{ variant.id }}"] = {
        title: "{{ variant.title | escape }}",
        {% if linked_variant %}
          hasMetafield: true,
          linkedId: "{{ linked_variant.id }}",
          linkedTitle: "{{ linked_variant.title | escape }}"
        {% else %}
          hasMetafield: false,
          linkedId: null
        {% endif %}
      };
    {% endfor %}

    console.log("âœ… [Main Product] Data Map Loaded");

    // ==================================================
    // 2. CORE SYNC FUNCTION (Reusable)
    // ==================================================
    /**
     * Handles the logic of broadcasting the change to the Bundle
     * regardless of whether it came from a Click or Page Load.
     */
    function broadcastVariantChange(variantId) {
      const data = mainProductData[variantId];

      if (data && data.hasMetafield) {
        // A. Save to Storage (Persistence)
        sessionStorage.setItem('target_bundle_id', data.linkedId);
        
        // B. Dispatch Event (Immediate Sync)
        const event = new CustomEvent('custom-variant-change', { 
          detail: { targetId: data.linkedId } 
        });
        window.dispatchEvent(event);
        
        console.log(`ðŸ“¡ [Sync] Broadcasting Target ID: ${data.linkedId} (Source: ${data.title})`);
      } else {
        // C. Cleanup if no link
        sessionStorage.removeItem('target_bundle_id');
        
        // Dispatch event with null to reset bundle visibility
        const event = new CustomEvent('custom-variant-change', { detail: { targetId: null } });
        window.dispatchEvent(event);
        
        console.log(`Start [Sync] No link found for variant: ${variantId}`);
      }
    }

    // ==================================================
    // 3. GALLERY LOGIC
    // ==================================================
    const thumbnails = document.querySelectorAll('.media-gallery-custom a');
    const mainImages = document.querySelectorAll('.main-image-wrapper-custom img');

    if (thumbnails.length > 0 && mainImages.length > 0) {
      thumbnails[0].classList.add('active');
      mainImages[0].classList.add('active');

      thumbnails.forEach((thumb, index) => {
        thumb.addEventListener('click', function(e) {
          e.preventDefault(); 
          for (let i = 0; i < thumbnails.length; i++) { thumbnails[i].classList.remove('active'); }
          for (let i = 0; i < mainImages.length; i++) { mainImages[i].classList.remove('active'); }
          this.classList.add('active');
          if (mainImages[index]) { mainImages[index].classList.add('active'); }
        });
      });
    }

    // ==================================================
    // 4. VARIANT LOGIC (The Fix)
    // ==================================================
    const mainWrapper = document.querySelector('.product-detail-wrapper');
    const productSelect = document.getElementById('productSelect');
    
    if (mainWrapper) {
      const buttons = mainWrapper.querySelectorAll('.checkbox-button');

      // A. EVENT LISTENER (Click Interaction)
      buttons.forEach(btn => {
        btn.addEventListener('click', function(e) {
          // Prevent Theme Conflict / Glitch
          e.preventDefault();
          e.stopPropagation(); 

          const id = this.getAttribute('data-value');

          // 1. UI UPDATE
          buttons.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          if(productSelect) productSelect.value = id;

          // 2. RUN SYNC LOGIC
          broadcastVariantChange(id);
        });
      });

      // B. INITIAL LOAD CHECK (Pre-Select Logic)
      // Find the button that is ALREADY active (set by Liquid or Theme JS)
      const initialActiveBtn = mainWrapper.querySelector('.checkbox-button.active');
      
      if (initialActiveBtn) {
        const initialId = initialActiveBtn.getAttribute('data-value');
        console.log("ðŸš€ [Main Product] Initializing Pre-selected Variant...");
        broadcastVariantChange(initialId);
      } else {
        // Fallback: If no button is active, trigger the first one logic
        const firstBtn = buttons[0];
        if (firstBtn) {
           const firstId = firstBtn.getAttribute('data-value');
           console.log("ðŸš€ [Main Product] Initializing First Variant (Fallback)...");
           broadcastVariantChange(firstId);
        }
      }
    }
  });
</script>


<style>
  .rich-text-container ul {
    margin-top: 7px;
    list-style-type: disc;
    list-style-position: inside;
  }
</style>