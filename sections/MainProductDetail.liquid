{% assign product_detail = product.metafields.custom.product_detail %}
{% assign product_detail = blank %}

<div class="main-grid product-detail-wrapper">

  <div class="gallery-wrapper">
    <div id="product-geallery-wrapper" class="native-gallery">

      <div class="native-gallery__main-scroll" id="MainSlider">
        {% assign slide_index = 0 %}
          {% for image in product.images %}
          {% assign image_alt = image.alt | escape %}

          {% comment %} Language Filter Logic {% endcomment %}
          {% if image.alt contains 'LANG:' %}
            {% assign image_alt = image.alt | split: "|" | last %}
            {% assign language_code = image.alt | split: "|" | first | remove: "LANG:" | downcase %}
            {% if language_code != request.locale.iso_code %}
              {% continue %}{% endif %}
          {% endif %}

          <div class="native-gallery__slide" data-index="{{ slide_index }}">
            <img
              src="{{ image.src | img_url: '1440x' }}"
              alt="{{ image_alt }}"
              loading="lazy"
              class="gallery-image">
          </div>
          {% assign slide_index = slide_index | plus: 1 %}
        {% endfor %}
      </div>

      <div class="native-gallery__thumbs-scroll" id="ThumbSlider">
        {% assign thumb_index = 0 %}
          {% for image in product.images %}
          {% comment %} Language Logic for Thumbs {% endcomment %}
          {% if image.alt contains 'LANG:' %}
            {% assign language_code = image.alt | split: "|" | first | remove: "LANG:" | downcase %}
            {% if language_code != request.locale.iso_code %}
              {% continue %}{% endif %}
          {% endif %}

          <button
            class="native-gallery__thumb {% if thumb_index == 0 %}active{% endif %}"
            data-index="{{ thumb_index }}"
            aria-label="View Image {{ thumb_index | plus: 1 }}">
            <div class="thumb-inner">
              <img src="{{ image.src | img_url: 'compact' }}" alt="{{ image.alt | escape }}">
            </div>
          </button>
          {% assign thumb_index = thumb_index | plus: 1 %}
        {% endfor %}
      </div>

    </div>
  </div>
  {% assign free_product = settings.free_product.id %}

  <div class="detail" id="product-detail-content">
    <div class="rating body-mobile">
      {% if product.metafields.custom.rating %}
        <div>
          {% render 'StarReview' %}
          <span class="rating-text">{{ product.metafields.custom.rating }}</span>
        </div>
      {% else %}
        {% render 'Rating' %}
      {% endif %}
    </div>

    <h1>{{ product.title }}</h1>
    {% render 'ProductTags' %}
    {% render 'ProductVideos' %}

    <div class="body-desk description">
      <div>{{ product.description }}</div>
      <div>
        {% assign rich_text_data = product.metafields.custom.advantage %}

        {% if rich_text_data != blank %}
          <div class="rich-text-container">
            {{ rich_text_data | metafield_tag }}
          </div>
        {% endif %}
      </div>
    </div>
    {% assign inside_set = product.metafields.custom.inside_set %}
    {% if inside_set != blank %}
      <div class="description body-desk inside-set-container">
        {% assign inside_set = product.metafields.custom.inside_set %}
        <div class="inside-set-wrapper">
          <p>
            {% if localization.language.iso_code == 'id' %}
              Isi Set
            {% else %}
              Inside the Set
            {% endif %}
          </p>

          <div class="inside-set-content rte">
            {{ inside_set | metafield_tag }}
          </div>
        </div>
      </div>
    {% endif %}
    {% render 'ProductStories' %}

    <div class="variant-button">
      {% if free_product != product.id %}
        {% render 'VariantsButton'
          , product: product %}
      {% endif %}
    </div>

    {% if free_product != product.id %}
      <form
        action="/cart/add"
        method="post"
        enctype="multipart/form-data"
        id="AddToCartForm">
        <select name="id" id="productSelect">
          {% for variant in product.variants %}
            {% if variant.available %}
              <option value="{{ variant.id }}">{{ variant.title }} - {{ variant.price | money_with_currency }}</option>
            {% else %}
              <option disabled="disabled">{{ variant.title }} - sold out</option>
            {% endif %}
          {% endfor %}
        </select>

        {% assign default_variant = product.variants[0].id %}

        {% for variant in product.variants %}
          {% assign set_default_varaint = variant.metafields.custom.set_default %}

          {%- if set_default_varaint -%}
            {% assign default_variant = variant.id %}
          {%- endif -%}
        {% endfor %}

        <input
          type="hidden"
          id="Quantity"
          name="quantity"
          value="1"
          min="1"
          max="1">
        <button
          data-variant="{{ default_variant }}"
          type="submit"
          class="button button-quick-add-cart"
          name="add"
          id="AddToCart">
          {{ 'products.general.add_to_cart' | t }}
        </button>
      </form>
    {% endif %}

    {% if product_detail.value.count > 0 %}
      <div class="product-detail-wrapper__list-description __accordion">
        {% for item in product_detail.value %}
          <div class="item __accordion-wrapper">
            <div class="button h3 __accordion-button">
              {{ item.title }}
              <svg
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 12 12">
                <path fill="#2B3C35" d="M7 5V0H5v5H0v2h5v5h2V7h5V5H7Z" />
              </svg>
            </div>
            <div class="description __accordion-content">
              {{ item.description | metafield_tag }}
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

</div>

{% schema %}
  {
    "name": "Product single",
    "tag": "section",
    "class": "section",
    "settings": [
      {
        "type": "text",
        "id": "payment_title",
        "label": "Payments title"
      },
      {
        "type": "image_picker",
        "id": "payment_list",
        "label": "Payments image desktop"
      },
      {
        "type": "image_picker",
        "id": "payment_list_mob",
        "label": "Payments image mobile"
      },
      {
        "type": "header",
        "content": "Note"
      }, {
        "type": "text",
        "id": "note",
        "label": "Note"
      }, {
        "type": "image_picker",
        "id": "note_image",
        "label": "Note image"
      }, {
        "type": "header",
        "content": "Product Stories / Reels"
      }, {
        "type": "text",
        "id": "story_title",
        "label": "Story Title"
      }, {
        "type": "text",
        "id": "story_cta_text",
        "label": "Story Button Label",
        "default": "Add to Cart"
      }, {
        "type": "color",
        "id": "story_text_color",
        "label": "Story Title Color",
        "default": "#000000"
      }, {
        "type": "color",
        "id": "story_btn_bg",
        "label": "Story Button Background",
        "default": "#526547"
      }, {
        "type": "color",
        "id": "story_btn_text",
        "label": "Story Button Text",
        "default": "#ffffff"
      }
    ],
    "presets": [
      {
        "name": "Product single"
      }
    ]
  }
{% endschema %}

<script>
  // 1. Run this immediately to stop browser from remembering scroll position
  if ('scrollRestoration' in history) {
    history.scrollRestoration = 'manual';
  }

  document.addEventListener("DOMContentLoaded", function() {
    
    // ==================================================
    // --- FIX START: ROBUST IOS SCROLL RESET ---
    // ==================================================
    const sliderReset = document.getElementById('MainSlider');

    function forceScrollToStart() {
      if (!sliderReset) return;

      // 1. Temporarily disable CSS smooth scrolling
      // (iOS often fails to reset position if 'smooth' is active during load)
      sliderReset.style.scrollBehavior = 'auto';
      sliderReset.style.webkitOverflowScrolling = 'auto';

      // 2. Force scroll to 0
      sliderReset.scrollLeft = 0;
      sliderReset.scrollTo({ left: 0, behavior: 'auto' });

      // 3. Re-enable smooth scrolling after a delay
      setTimeout(() => {
        sliderReset.style.scrollBehavior = '';
        sliderReset.style.webkitOverflowScrolling = '';
      }, 150);
    }

    // Trigger 1: Immediately on DOM Ready
    forceScrollToStart();

    // Trigger 2: Short delay (catches fast renders)
    setTimeout(forceScrollToStart, 50);

    // Trigger 3: When all images/content are fully loaded (Crucial for iOS)
    window.addEventListener('load', () => {
       setTimeout(forceScrollToStart, 10);
    });
    // ==================================================
    // --- FIX END ---
    // ==================================================


    // ==================================================
    // 1. DATA SOURCE: VARIANT & METAFIELD MAP
    // ==================================================
    const mainProductData = {};
    
    {% for variant in product.variants %}
      {% assign linked_variant = variant.metafields.custom.product_integration.value %}
      mainProductData["{{ variant.id }}"] = {
        title: "{{ variant.title | escape }}",
        {% if linked_variant %}
          hasMetafield: true,
          linkedId: "{{ linked_variant.id }}",
          linkedTitle: "{{ linked_variant.title | escape }}"
        {% else %}
          hasMetafield: false,
          linkedId: null
        {% endif %}
      };
    {% endfor %}

    // ==================================================
    // 2. CORE SYNC FUNCTION
    // ==================================================
    function broadcastVariantChange(variantId) {
      const data = mainProductData[variantId];

      if (data && data.hasMetafield) {
        sessionStorage.setItem('target_bundle_id', data.linkedId);
        
        const event = new CustomEvent('custom-variant-change', { 
          detail: { targetId: data.linkedId } 
        });
        window.dispatchEvent(event);
      } else {
        sessionStorage.removeItem('target_bundle_id');
        
        const event = new CustomEvent('custom-variant-change', { detail: { targetId: null } });
        window.dispatchEvent(event);
      }
    }

    // ==================================================
    // 3. NATIVE GALLERY LOGIC (Replaces Swiper)
    // ==================================================
    const mainSlider = document.getElementById('MainSlider');
    const thumbSlider = document.getElementById('ThumbSlider');
    const thumbs = document.querySelectorAll('.native-gallery__thumb');
    
    if (mainSlider && thumbs.length > 0) {
      
      // A. Handle Thumbnail Clicks
      thumbs.forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          const index = parseInt(this.getAttribute('data-index'));
          const slideWidth = mainSlider.offsetWidth;
          
          // Scroll main slider to specific position
          mainSlider.scrollTo({
            left: slideWidth * index,
            behavior: 'smooth'
          });
        });
      });

      // B. Handle Scroll Spy (Update Active Thumb on Scroll)
      let isScrolling;
      mainSlider.addEventListener('scroll', function() {
        window.clearTimeout( isScrolling );
        
        // Debounce slightly to prevent flicker
        isScrolling = setTimeout(function() {
          const slideWidth = mainSlider.offsetWidth;
          const scrollPos = mainSlider.scrollLeft;
          
          // Calculate current index
          const currentIndex = Math.round(scrollPos / slideWidth);
          
          // Update active classes
          thumbs.forEach(t => t.classList.remove('active'));
          
          const activeThumb = document.querySelector(`.native-gallery__thumb[data-index="${currentIndex}"]`);
          if (activeThumb) {
            activeThumb.classList.add('active');
            
            // Keep active thumbnail visible in strip
            activeThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
          }
        }, 60);
      });
    }

    // ==================================================
    // 4. VARIANT LOGIC
    // ==================================================
    const mainWrapper = document.querySelector('.product-detail-wrapper');
    const productSelect = document.getElementById('productSelect');
    
    if (mainWrapper) {
      const buttons = mainWrapper.querySelectorAll('.checkbox-button');

      buttons.forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation(); 

          const id = this.getAttribute('data-value');

          buttons.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          if(productSelect) productSelect.value = id;

          broadcastVariantChange(id);
        });
      });

      const initialActiveBtn = mainWrapper.querySelector('.checkbox-button.active');
      
      if (initialActiveBtn) {
        const initialId = initialActiveBtn.getAttribute('data-value');
        broadcastVariantChange(initialId);
      } else {
        const firstBtn = buttons[0];
        if (firstBtn) {
           const firstId = firstBtn.getAttribute('data-value');
           broadcastVariantChange(firstId);
        }
      }
    }
  });
</script>

<style>
  .product-detail-wrapper .inside-set-container {
    margin-top: 18px;
  }
  .rich-text-container ul {
    margin-top: 7px;
    list-style-type: disc;
    list-style-position: inside;
  }

  /* GRID LAYOUT */
  .product-detail-wrapper .gallery-wrapper {
    grid-column: 2 / 8;
    width: 100%;
    max-width: 100%;
    overflow: hidden;
  }

  /* NATIVE GALLERY STYLES */
  .native-gallery {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 10px;
    position: relative;
  }

  /* 1. Main Slider Container */
  .native-gallery__main-scroll {
    display: flex;
    width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    /* CSS Scroll Snap Magic */
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;

    /* Hide Scrollbar */
    scrollbar-width: none;
    /* Firefox */
    -ms-overflow-style: none;
    /* IE 10+ */
  }
  .native-gallery__main-scroll::-webkit-scrollbar {
    display: none;
    /* Chrome/Safari */
  }

  /* 2. Main Slide */
  .native-gallery__slide {
    border-radius: 8px;
    overflow: hidden;
    flex: 0 0 100%;
    /* Force 100% width */
    width: 100%;
    scroll-snap-align: start;
    /* Snap exactly to start */
    scroll-snap-stop: always;
    /* Prevent skipping slides */
    position: relative;
  }

  .native-gallery__slide img {
    width: 100%;
    height: auto;
    display: block;
    object-fit: cover;
  }

  /* 3. Thumbnail Strip */
  .native-gallery__thumbs-scroll {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding-bottom: 5px;
    /* Matches legacy padding */
    scrollbar-width: none;
  }

  @media only screen and (max-width: 768px) {
    .native-gallery__thumbs-scroll {
      margin-left: 24px;
    }
  }

  .native-gallery__thumb {
    flex: 0 0 70px;
    /* Fixed width thumbs */
    height: 65px;
    border: none;
    background: none;
    padding: 0;
    cursor: pointer;
    opacity: 0.6;
    transition: opacity 0.3s ease;
  }

  .native-gallery__thumb .thumb-inner {
    width: 100%;
    height: 100%;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid transparent;
  }

  .native-gallery__thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Active State */
  .native-gallery__thumb.active {
    opacity: 1;
  }
  .native-gallery__thumb.active .thumb-inner {
    border-color: #567350;
  }

  /* MOBILE ADJUSTMENTS */
  @media only screen and (max-width: 768px) {
    .native-gallery__thumbs-scroll {
      margin-left: 24px;
    }
  }
</style>